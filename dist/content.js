function e(){if(document.querySelector(".screenshot-overlay"))return;const e={isDrawing:!1,isSelected:!1,isDragSelecting:!1,selection:null,selectedElement:null,highlightElement:null,highlightTimeout:null,history:[],historyIndex:-1,currentTool:null,isCornerStylePanelVisible:!1,isLineWidthPanelVisible:!1,isArrowStylePanelVisible:!1,isShapeStylePanelVisible:!1,isTextStylePanelVisible:!1},o={overlay:function(){const e=document.createElement("div");return e.className="screenshot-overlay",e}(),hint:function(){const e=document.createElement("div");e.className="screenshot-hint",e.innerHTML='\n      <div class="screenshot-hint-text">\n        在此页面上拖拽或单击选择截图区域<br>\n        按 ESC 键取消截图\n      </div>\n    ';const t=document.createElement("button");return t.className="screenshot-hint-button",t.textContent="取消",t.onclick=e=>{e.preventDefault(),e.stopPropagation(),g()},e.appendChild(t),e}(),sizeDisplay:function(){const e=document.createElement("div");return e.className="size-display",Object.assign(e.style,{position:"absolute",left:"0",top:"-30px",background:"rgba(0, 0, 0, 0.7)",color:"white",padding:"4px 8px",borderRadius:"4px",fontSize:"12px",fontFamily:"Arial, sans-serif",zIndex:"1000002",pointerEvents:"none"}),e}()};const i={create(t){e.highlightTimeout&&clearTimeout(e.highlightTimeout),e.highlightTimeout=setTimeout((()=>{this.remove();const n=t.getBoundingClientRect();e.highlightElement=document.createElement("div"),e.highlightElement.className="element-highlight",this.updatePosition(e.highlightElement,n),document.body.appendChild(e.highlightElement)}),5)},remove(){e.highlightElement&&(e.highlightElement.remove(),e.highlightElement=null)},updatePosition(e,t){e.style.position="fixed",e.style.left=`${t.left}px`,e.style.top=`${t.top}px`,e.style.width=`${t.width}px`,e.style.height=`${t.height}px`}},s={create:()=>(e.selection=document.createElement("div"),e.selection.className="selected-element",Object.assign(e.selection.style,{position:"fixed",border:"1px solid #1a73e8",backgroundColor:"transparent",boxSizing:"border-box",zIndex:"1000000",overflow:"visible",clipPath:"none",pointerEvents:"auto"}),document.body.appendChild(e.selection),e.selection.appendChild(o.sizeDisplay),u(e.selection),p(e.selection),t.create(e.selection),r.create(e.selection),e.selection),updatePosition(t){if(!e.selection)return;let{left:n,top:i,width:s,height:r}=this.checkBoundary(t);e.selection.style.position="fixed",e.selection.style.left=`${n}px`,e.selection.style.top=`${i}px`,e.selection.style.width=`${s}px`,e.selection.style.height=`${r}px`,o.sizeDisplay.textContent=`${Math.round(s)}×${Math.round(r)}`,this.updateClipPath(n,i,s,r)},checkBoundary(e){let{left:t,top:n,width:o,height:i}=e;const s=document.documentElement.clientWidth,r=document.documentElement.clientHeight;t<3&&(t=3,o>s-6&&(o=s-6)),t+o>s-50-3&&(t>3?o=s-t-50-3:(t=3,o=s-50-6)),n<3&&(n=3,i>r-60-6&&(i=r-60-6)),n+i+60>r-3&&(n>3?i=r-n-60-3:(n=3,i=r-60-6));return o=Math.max(o,20),i=Math.max(i,20),{left:t,top:n,width:o,height:i}},updateClipPath(e,t,n,i){const s=document.documentElement.clientWidth,r=document.documentElement.clientHeight,a=e/s*100,l=t/r*100,c=n/s*100,d=i/r*100;o.overlay.style.background="rgba(0, 0, 0, 0.5)",o.overlay.style.clipPath=`\n        polygon(\n          0 0, 100% 0, 100% 100%, 0 100%, 0 0,\n          ${a}% ${l}%,\n          ${a}% ${l+d}%,\n          ${a+c}% ${l+d}%,\n          ${a+c}% ${l}%,\n          ${a}% ${l}%\n        )\n      `;const h=document.querySelector(".selected-element");h&&(h.style.clipPath="none",h.style.background="transparent")}},r={create(e){const t=e.querySelector(".toolbar");t&&t.remove();const n=document.createElement("div");n.className="toolbar";[this.createCloseButton(),this.createFullscreenButton(),this.createDownloadButton(),this.createCopyButton()].forEach((e=>n.appendChild(e))),e.appendChild(n),this.setStyle(n)},setStyle(e){Object.assign(e.style,{width:"250px",height:"46px",position:"absolute",right:"-1px",bottom:"-60px",whiteSpace:"nowrap",display:"flex",justifyContent:"space-around",alignItems:"center",zIndex:"1000002"})},createCloseButton(){return this.createButton("toolbar-button-cancel","X",g)},createFullscreenButton(){return this.createButton("toolbar-button-visible","全屏",(()=>{this.capture("captureVisible")}))},createDownloadButton(){return this.createButton("toolbar-button","下载",(()=>{const t=e.selection.getBoundingClientRect(),n=document.querySelector(".annotation-canvas"),o=n?n.toDataURL("image/png"):null;this.capture("captureArea",{x:t.left,y:t.top,width:t.width,height:t.height,sourceCanvas:o})}))},createCopyButton(){const t=document.createElement("button");return t.className="toolbar-button",t.innerHTML='\n        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">\n          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>\n          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>\n        </svg>\n        复制\n      ',t.addEventListener("click",(async()=>{const t=e.selection.getBoundingClientRect(),n=document.querySelector(".annotation-canvas"),o=n?n.toDataURL("image/png"):null;this.capture("copyArea",{x:t.left,y:t.top,width:t.width,height:t.height,sourceCanvas:o})})),t},createButton(e,t,n){const o=document.createElement("button");return o.className=e,o.innerHTML=this.getButtonHTML(t),o.onclick=e=>{e.preventDefault(),e.stopPropagation(),n()},o},getButtonHTML(e){switch(e){case"X":return'\n            <svg width="16" height="16" viewBox="0 0 16 16">\n              <path d="M8 6.586L3.707 2.293 2.293 3.707 6.586 8l-4.293 4.293 1.414 1.414L8 9.414l4.293 4.293 1.414-1.414L9.414 8l4.293-4.293-1.414-1.414L8 6.586z"/>\n            </svg>\n          ';case"全屏":return'\n            <div style="display: flex; align-items: center; justify-content: center;">\n              <svg width="16" height="16" viewBox="0 0 16 16" style="margin-right: 4px;">\n                <path d="M1.5 1h4v1.5h-2.5v2.5h-1.5v-4zm13 0v4h-1.5v-2.5h-2.5v-1.5h4zm-13 13v-4h1.5v2.5h2.5v1.5h-4zm13 0h-4v-1.5h2.5v-2.5h1.5v4z"/>\n              </svg>\n              <span>全屏</span>\n            </div>\n          ';case"下载":return'\n            <div style="display: flex; align-items: center; justify-content: center; fill: white;">\n              <svg width="16" height="16" viewBox="0 0 16 16" style="margin-right: 4px;">\n                <path d="M8 12l-4.5-4.5 1.5-1.5 2 2v-6h2v6l2-2 1.5 1.5-4.5 4.5zm-6 2h12v-2h-12v2z"/>\n              </svg>\n              <span>下载</span>\n            </div>\n          ';default:return e}},capture(t,i=null){o.overlay.style.display="none",e.selection.style.display="none",chrome.runtime.sendMessage({action:t,...i&&{area:i}},(async e=>{if(e?.success){if(e.dataURL){const t=function(e){const[t,n]=e.split(","),o=t.match(/:(.*?);/)[1],i=atob(n),s=i.length,r=new Uint8Array(s);for(let e=0;e<s;e++)r[e]=i.charCodeAt(e);return new Blob([r],{type:o})}(e.dataURL);try{const e=new ClipboardItem({[t.type]:t});await navigator.clipboard.write([e]),n("已复制到剪贴板")}catch(e){n("复制失败，请重试")}}}else n("操作失败，请重试");g()}))}};function a(t){if(o.overlay.parentElement&&!e.isSelected){o.overlay.style.pointerEvents="none";const n=document.elementFromPoint(t.clientX,t.clientY);o.overlay.style.pointerEvents="auto",!n||n.classList.contains("screenshot-overlay")||n.classList.contains("element-highlight")||n===e.selectedElement||(i.create(n),e.selectedElement=n)}}function l(t){if(!o.overlay.parentElement||e.isSelected)return;const n=t.clientX,a=t.clientY;let l=!1;function c(t){const r=Math.abs(t.clientX-n),c=Math.abs(t.clientY-a);if(r>5||c>5){l=!0,o.hint.classList.add("hidden"),i.remove(),e.selectedElement=null,e.selection||(e.selection=s.create(),u(e.selection),p(e.selection));const r={left:Math.min(n,t.clientX),top:Math.min(a,t.clientY),width:Math.abs(t.clientX-n),height:Math.abs(t.clientY-a)};s.updatePosition(r)}}return document.addEventListener("mousemove",c),document.addEventListener("mouseup",(function t(n){if(document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",t),l&&e.selection){const t=e.selection.getBoundingClientRect();t.width>=20&&t.height>=20?(e.isSelected=!0,r.create(e.selection)):(e.selection.parentElement&&e.selection.remove(),e.selection=null)}else if(e.selectedElement){e.isSelected=!0;const t=e.selectedElement.getBoundingClientRect();e.selection=s.create(),s.updatePosition(t),i.remove(),u(e.selection),p(e.selection),r.create(e.selection)}})),e.selectedElement?(e.isSelected=!0,t.preventDefault(),void t.stopPropagation()):void 0}function c(){o.overlay.parentElement||g()}function d(t){if("Escape"!==t.key){if((t.metaKey||t.ctrlKey)&&"c"===t.key&&e.selection){t.preventDefault();const n=e.selection.getBoundingClientRect(),o=document.querySelector(".annotation-canvas"),i=o?o.toDataURL("image/png"):null;r.capture("copyArea",{x:n.left,y:n.top,width:n.width,height:n.height,sourceCanvas:i})}}else g()}function h(){if(e.selection&&e.isSelected){const t=e.selection.getBoundingClientRect();s.updatePosition(t)}}function u(e){const t=document.createElement("div");t.className="drag-handle",Object.assign(t.style,{position:"absolute",top:"0",left:"0",right:"0",bottom:"0",cursor:"move",zIndex:"1000000",pointerEvents:"auto"}),e.insertBefore(t,e.firstChild),t.addEventListener("mousedown",(t=>{t.preventDefault(),t.stopPropagation();const n=e.querySelector(".annotation-canvas");n&&(n.style.pointerEvents="none");const o=t.clientX,i=t.clientY,r=e.getBoundingClientRect(),a=e=>{e.preventDefault(),e.stopPropagation();const t=e.clientX-o,n=e.clientY-i,a={left:r.left+t,top:r.top+n,width:r.width,height:r.height};s.updatePosition(a)},l=()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)})),e.addEventListener("toolchange",(e=>{const n="select"===e.detail.tool,o=["pen","eraser","arrow","rectangle","circle","text"].includes(e.detail.tool);n||!e.detail.tool?(t.style.pointerEvents="auto",t.style.cursor="move"):o&&(t.style.pointerEvents="none",t.style.cursor="default")}))}function p(e){["nw","n","ne","w","e","sw","s","se"].forEach((t=>{const n=document.createElement("div");n.className=`resize-handle ${t}`,n.style.pointerEvents="auto",n.style.zIndex="1000002",e.appendChild(n),n.onpointerdown=function(n){n.preventDefault(),n.stopPropagation();const o=n.clientX,i=n.clientY,r={left:e.offsetLeft,top:e.offsetTop,width:e.offsetWidth,height:e.offsetHeight,right:e.offsetLeft+e.offsetWidth,bottom:e.offsetTop+e.offsetHeight};function a(e){e.preventDefault(),e.stopPropagation();const n=e.clientX-o,a=e.clientY-i;let l={left:r.left,top:r.top,width:r.width,height:r.height};switch(t){case"nw":l.left=r.left+n,l.top=r.top+a,l.width=r.width-n,l.height=r.height-a;break;case"n":l.top=r.top+a,l.height=r.height-a;break;case"ne":l.top=r.top+a,l.width=r.width+n,l.height=r.height-a;break;case"w":l.left=r.left+n,l.width=r.width-n;break;case"e":l.width=r.width+n;break;case"sw":l.left=r.left+n,l.width=r.width-n,l.height=r.height+a;break;case"s":l.height=r.height+a;break;case"se":l.width=r.width+n,l.height=r.height+a}s.updatePosition(l)}function l(){document.removeEventListener("pointermove",a),document.removeEventListener("pointerup",l),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)}document.addEventListener("pointermove",a),document.addEventListener("pointerup",l),document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)}}))}function g(){i.remove(),[o.overlay,e.selection,o.hint].forEach((e=>{e?.parentElement&&e.remove()})),t.state={currentPenWidth:2,currentPenColor:"#ff0000",currentEraserWidth:8,currentArrowWidth:2,currentArrowColor:"#ff0000",currentCornerStyle:"round",currentShapeStyle:"stroke",currentShapeColor:"#ff0000",currentFontFamily:"Arial",currentFontSize:16,currentTextColor:"#ff0000",history:[],historyIndex:-1,currentTool:null,isCornerStylePanelVisible:!1,isLineWidthPanelVisible:!1,isArrowStylePanelVisible:!1,isShapeStylePanelVisible:!1,isTextStylePanelVisible:!1,availableCornerStyles:t.state.availableCornerStyles,availableFonts:t.state.availableFonts,availableSizes:t.state.availableSizes},document.removeEventListener("mousemove",a),document.removeEventListener("mousedown",l),document.removeEventListener("mouseup",c),document.removeEventListener("keydown",d),window.removeEventListener("resize",h)}o.overlay.appendChild(o.hint),document.body.appendChild(o.overlay),document.addEventListener("mousemove",a),document.addEventListener("mousedown",l),document.addEventListener("mouseup",c),document.addEventListener("keydown",d),window.addEventListener("resize",h)}chrome.runtime.onMessage.addListener(((t,n,o)=>{"initScreenshot"===t.action&&e()}));const t={state:{currentColor:"#ff0000",currentLineWidth:2,currentPenColor:"#ff0000",currentPenWidth:2,currentEraserWidth:2,currentArrowColor:"#ff0000",currentArrowWidth:2,currentArrowStyle:"solid",currentShapeColor:"#ff0000",currentShapeWidth:2,currentShapeFillColor:"transparent",currentShapeStyle:"solid",currentCornerStyle:"sharp",currentTextColor:"#ff0000",currentFontSize:16,currentFontFamily:"Arial",availableFonts:[{name:"Arial",label:"默认字体",type:"system"},{name:"CustomFont1",label:"手写体",type:"custom",url:"https://excalidraw.nyc3.cdn.digitaloceanspaces.com/oss/fonts/Excalifont/Excalifont-Regular-a88b72a24fb54c9f94e3b5fdaa7481c9.woff2"},{name:"CustomFont2",label:"艺术体",type:"custom",url:"https://excalidraw.nyc3.cdn.digitaloceanspaces.com/oss/fonts/Lilita/Lilita-Regular-i7dPIFZ9Zz-WBtRtedDbYEF8RXi4EwQ.woff2"},{name:"CustomFont3",label:"手写体",type:"custom",url:"https://excalidraw.nyc3.cdn.digitaloceanspaces.com/oss/fonts/CascadiaCode/CascadiaCode-Regular.woff2"}],availableSizes:[{value:12,label:"S"},{value:16,label:"M"},{value:20,label:"L"},{value:24,label:"XL"}],isLineWidthPanelVisible:!1,isArrowStylePanelVisible:!1,isShapeStylePanelVisible:!1,isTextStylePanelVisible:!1,history:[],historyIndex:-1,currentTool:null},loadCustomFonts(){const e=document.createElement("style"),t=this.state.availableFonts.filter((e=>"custom"===e.type)).map((e=>`\n        @font-face {\n          font-family: '${e.name}';\n          src: url('${e.url}') format('truetype');\n          font-weight: normal;\n          font-style: normal;\n          font-display: swap;\n        }\n      `)).join("\n");e.textContent=t,document.head.appendChild(e),this.state.availableFonts.filter((e=>"custom"===e.type)).forEach((e=>{new FontFace(e.name,`url(${e.url})`).load().then((e=>{document.fonts.add(e)})).catch((e=>{}))}))},create(e){const t=document.createElement("div");t.className="annotation-toolbar";[{id:"select",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="currentColor" d="M8 13.75L9.975 11h4.25L8 6.1zm7.15 7.625q-.575.275-1.15.063t-.85-.788l-3-6.45l-2.325 3.25q-.425.6-1.125.375t-.7-.95V4.05q0-.625.563-.9t1.062.125l10.1 7.95q.575.425.338 1.1T17.1 13h-4.2l2.975 6.375q.275.575.063 1.15t-.788.85M9.975 11"/></svg>',tooltip:"选择"},{id:"pen",icon:"✏️",tooltip:"画笔",hasLineWidth:!0},{id:"eraser",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 20 20"><path fill="currentColor" d="M11.197 2.44a1.5 1.5 0 0 1 2.121 0l4.243 4.242a1.5 1.5 0 0 1 0 2.121L9.364 17H14.5a.5.5 0 1 1 0 1H7.82a1.5 1.5 0 0 1-1.14-.437L2.437 13.32a1.5 1.5 0 0 1 0-2.121zm1.414.706a.5.5 0 0 0-.707 0L5.538 9.512l4.95 4.95l6.366-6.366a.5.5 0 0 0 0-.707zM9.781 15.17l-4.95-4.95l-1.687 1.687a.5.5 0 0 0 0 .707l4.243 4.243a.5.5 0 0 0 .707 0z"/></svg>',tooltip:"橡皮擦",hasLineWidth:!0},{id:"arrow",icon:"➡️",tooltip:"箭头",hasArrowStyle:!0,hasLineWidth:!0},{id:"rectangle",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.357 9.3c0-1.68 0-2.52.327-3.162a3 3 0 0 1 1.311-1.311C4.637 4.5 5.477 4.5 7.157 4.5h9.686c1.68 0 2.52 0 3.162.327a3 3 0 0 1 1.31 1.311c.328.642.328 1.482.328 3.162v5.4c0 1.68 0 2.52-.327 3.162a3 3 0 0 1-1.311 1.311c-.642.327-1.482.327-3.162.327H7.157c-1.68 0-2.52 0-3.162-.327a3 3 0 0 1-1.31-1.311c-.328-.642-.328-1.482-.328-3.162z"/></svg>',tooltip:"矩形",hasShapeStyle:!0},{id:"circle",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10s10-4.47 10-10S17.53 2 12 2m0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8s8 3.58 8 8s-3.58 8-8 8"/></svg>',tooltip:"椭圆",hasShapeStyle:!0},{id:"text",icon:'<svg aria-hidden="true" focusable="false" role="img" viewBox="0 0 24 24" class="" fill="none" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><g stroke-width="1.5"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><line x1="4" y1="20" x2="7" y2="20"></line><line x1="14" y1="20" x2="21" y2="20"></line><line x1="6.9" y1="15" x2="13.8" y2="15"></line><line x1="10.2" y1="6.3" x2="16" y2="20"></line><polyline points="5 20 11 4 13 4 20 20"></polyline></g></svg>',tooltip:"���字"},{id:"divider",type:"divider"},{id:"undo",icon:"↩️",tooltip:"撤销"},{id:"redo",icon:"↪️",tooltip:"重做"}].forEach((e=>{if("divider"===e.type){const e=document.createElement("div");e.style.height="1px",e.style.backgroundColor="#444",e.style.margin="4px 0",t.appendChild(e)}else{const n=document.createElement("div");n.className="tool-button-container",n.style.position="relative";const o=this.createToolButton(e);if(n.appendChild(o),e.hasLineWidth){const t=this.createLineWidthPanel(e.id);n.appendChild(t)}if(e.hasArrowStyle){const e=this.createArrowStylePanel();n.appendChild(e)}if(e.hasShapeStyle){const e=this.createShapeStylePanel();n.appendChild(e)}t.appendChild(n)}})),e.appendChild(t),this.setStyle(t)},createToolButton({id:e,icon:t,tooltip:n}){const o=document.createElement("button");return o.className="annotation-tool-button",o.dataset.tool=e,o.title=n,o.innerHTML=t,Object.assign(o.style,{width:"32px",height:"32px",border:"none",borderRadius:"4px",backgroundColor:"transparent",color:"white",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"16px",padding:"0",margin:"0 auto"}),o.addEventListener("click",(t=>{t.stopPropagation(),this.handleToolClick(e)})),o},handleToolClick(e){const t=document.querySelector(".selected-element");if(!t)return;const n=this.state.currentTool;this.state.currentTool=e;document.querySelectorAll(".annotation-tool-button").forEach((t=>{t.style.backgroundColor="transparent",t.dataset.tool===e&&(t.style.backgroundColor="#4c4c4c")}));if(t.querySelectorAll(".line-width-panel, .arrow-style-panel, .shape-style-panel, .text-style-panel").forEach((e=>e.remove())),["pen","eraser"].includes(e))if(n===e)this.toggleLineWidthPanel(!this.state.isLineWidthPanelVisible,e);else{t.querySelector(`[data-tool="${e}"]`).parentElement.appendChild(this.createLineWidthPanel(e)),this.toggleLineWidthPanel(!0,e)}else if("arrow"===e)if(n===e)this.toggleArrowStylePanel(!this.state.isArrowStylePanelVisible);else{t.querySelector(`[data-tool="${e}"]`).parentElement.appendChild(this.createArrowStylePanel()),this.toggleArrowStylePanel(!0)}else if(["rectangle","circle"].includes(e))if(n===e)this.toggleShapeStylePanel(!this.state.isShapeStylePanelVisible);else{t.querySelector(`[data-tool="${e}"]`).parentElement.appendChild(this.createShapeStylePanel()),this.toggleShapeStylePanel(!0)}else if("text"===e)if(n===e)this.toggleTextStylePanel(!this.state.isTextStylePanelVisible);else{t.querySelector(`[data-tool="${e}"]`).parentElement.appendChild(this.createTextStylePanel()),this.toggleTextStylePanel(!0)}else if("blur"===e)if(n===e)this.toggleBlurSettingsPanel(!this.state.isBlurSettingsPanelVisible);else{t.querySelector(`[data-tool="${e}"]`).parentElement.appendChild(this.createBlurSettingsPanel()),this.toggleBlurSettingsPanel(!0)}else["pen","eraser"].forEach((e=>this.toggleLineWidthPanel(!1,e))),this.toggleArrowStylePanel(!1),this.toggleShapeStylePanel(!1),this.toggleTextStylePanel(!1),this.toggleBlurSettingsPanel(!1);if("undo"===e||"redo"===e){const n=t.querySelector(".annotation-canvas");return void(n&&(n.style.pointerEvents="none","undo"===e?this.undo(n):this.redo(n)))}this.initDrawingCanvas(e);const o=new CustomEvent("toolchange",{detail:{tool:e}});if(t.dispatchEvent(o),"select"===e){const e=t.querySelector(".drag-handle");e&&(e.style.pointerEvents="auto",e.style.cursor="move");const n=t.querySelector(".annotation-canvas");n&&(n.style.pointerEvents="none")}else{const n=t.querySelector(".drag-handle");if(n&&(n.style.pointerEvents="none",n.style.cursor="default"),["pen","eraser","arrow","rectangle","circle","text"].includes(e)){const e=t.querySelector(".annotation-canvas");e&&(e.style.pointerEvents="auto")}}},initDrawingCanvas(e){const t=document.querySelector(".selected-element");if(!t)return;let n=t.querySelector(".annotation-canvas");if(!n){n=document.createElement("canvas"),n.className="annotation-canvas";const e=t.getBoundingClientRect();n.width=e.width,n.height=e.height,Object.assign(n.style,{position:"absolute",left:"0",top:"0",width:"100%",height:"100%",zIndex:"1000001",cursor:"crosshair"});n.getContext("2d").clearRect(0,0,n.width,n.height),t.appendChild(n)}else n.penToolListeners&&Object.entries(n.penToolListeners).forEach((([e,t])=>{n.removeEventListener(e,t)})),n.blurToolListeners&&Object.entries(n.blurToolListeners).forEach((([e,t])=>{n.removeEventListener(e,t)}));const o=n.getContext("2d");switch(e){case"pen":this.initPenTool(n,o);break;case"eraser":this.initEraserTool(n,o);break;case"arrow":this.initArrowTool(n,o);break;case"rectangle":this.initRectangleTool(n,o);break;case"circle":this.initCircleTool(n,o);break;case"text":this.initTextTool(n,o);break;case"blur":this.initBlurTool(n,o)}if(this.state.history.length>0){const e=this.state.history[this.state.historyIndex];if(e){const t=new Image;t.onload=()=>{o.drawImage(t,0,0)},t.src=e}}},setStyle(e){Object.assign(e.style,{position:"absolute",right:"-60px",top:"0",width:"40px",backgroundColor:"#2c2c2c",borderRadius:"6px",display:"flex",flexDirection:"column",gap:"8px",padding:"8px 4px",zIndex:"1000002",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.15)"})},initPenTool(e,t){t.strokeStyle=this.state.currentPenColor,t.lineWidth=this.state.currentPenWidth,t.lineCap="round",t.lineJoin="round",t.globalCompositeOperation="source-over",t.imageSmoothingEnabled=!0;let n=!1,o=null,i=[];const s=t=>{n=!0;const s=e.getBoundingClientRect(),r=t.clientX-s.left,a=t.clientY-s.top;o={x:r,y:a},i=[o]},r=s=>{if(!n)return;const r=e.getBoundingClientRect(),a={x:s.clientX-r.left,y:s.clientY-r.top};var l,c;(l=o,c=a,Math.sqrt(Math.pow(c.x-l.x,2)+Math.pow(c.y-l.y,2)))<2||(i.push(a),i.length>5&&(i=i.slice(-5)),t.beginPath(),t.moveTo(o.x,o.y),t.lineTo(a.x,a.y),t.stroke(),o=a)},a=()=>{n&&(n=!1,this.saveState(e),i=[],o=null)},l=()=>{n&&(n=!1,this.saveState(e),i=[],o=null)};e.addEventListener("mousedown",s),e.addEventListener("mousemove",r),e.addEventListener("mouseup",a),e.addEventListener("mouseleave",l),e.penToolListeners={mousedown:s,mousemove:r,mouseup:a,mouseleave:l}},saveState(e){if(!e)return;e.getContext("2d")&&(this.state.history=this.state.history.slice(0,this.state.historyIndex+1),this.state.history.push(e.toDataURL()),this.state.historyIndex++,this.updateUndoRedoButtons())},undo(e){this.state.historyIndex>0&&(this.state.historyIndex--,this.loadState(e))},redo(e){this.state.historyIndex<this.state.history.length-1&&(this.state.historyIndex++,this.loadState(e))},loadState(e){if(!e)return;const t=e.getContext("2d");if(t&&this.state.history[this.state.historyIndex]){const n=new Image;n.onload=()=>{t.clearRect(0,0,e.width,e.height),t.drawImage(n,0,0)},n.src=this.state.history[this.state.historyIndex],this.updateUndoRedoButtons()}},updateUndoRedoButtons(){const e=document.querySelector('[data-tool="undo"]'),t=document.querySelector('[data-tool="redo"]');e&&(e.style.opacity=this.state.historyIndex>0?"1":"0.5"),t&&(t.style.opacity=this.state.historyIndex<this.state.history.length-1?"1":"0.5")},initEraserTool(e,t){let n=!1,o=0,i=0;const s=s=>{n=!0;const r=e.getBoundingClientRect();o=s.clientX-r.left,i=s.clientY-r.top,t.globalCompositeOperation="destination-out",t.lineWidth=this.state.currentEraserWidth,t.lineCap="round",t.lineJoin="round"},r=s=>{if(!n)return;const r=e.getBoundingClientRect(),a=s.clientX-r.left,l=s.clientY-r.top;t.beginPath(),t.moveTo(o,i),t.lineTo(a,l),t.stroke(),o=a,i=l},a=()=>{n&&(n=!1,t.globalCompositeOperation="source-over",this.saveState(e))},l=()=>{n&&(n=!1,t.globalCompositeOperation="source-over",this.saveState(e))};e.addEventListener("mousedown",s),e.addEventListener("mousemove",r),e.addEventListener("mouseup",a),e.addEventListener("mouseleave",l),e.eraserToolListeners={mousedown:s,mousemove:r,mouseup:a,mouseleave:l}},initArrowTool(e,t){let n=!1,o=0,i=0,s=document.createElement("canvas");s.width=e.width,s.height=e.height;let r=s.getContext("2d");const a=(e,n,o,i)=>{const s=Math.sqrt(Math.pow(o-e,2)+Math.pow(i-n,2)),r=Math.min(20,s/3),a=Math.atan2(i-n,o-e);switch(t.beginPath(),t.strokeStyle=this.state.currentArrowColor,t.lineWidth=this.state.currentArrowWidth,t.lineCap="round",t.lineJoin="round",this.state.currentArrowStyle){case"dashed":t.setLineDash([8,8]);break;case"denseDashed":t.setLineDash([4,4]);break;default:t.setLineDash([])}t.beginPath(),t.moveTo(e,n),t.lineTo(o,i);const l=o-r*Math.cos(a-Math.PI/6),c=i-r*Math.sin(a-Math.PI/6),d=o-r*Math.cos(a+Math.PI/6),h=i-r*Math.sin(a+Math.PI/6);t.moveTo(o,i),t.lineTo(l,c),t.moveTo(o,i),t.lineTo(d,h),t.stroke(),t.setLineDash([])},l=t=>{n=!0;const a=e.getBoundingClientRect();o=t.clientX-a.left,i=t.clientY-a.top,r.clearRect(0,0,s.width,s.height),r.drawImage(e,0,0)},c=r=>{if(!n)return;const l=e.getBoundingClientRect(),c=r.clientX-l.left,d=r.clientY-l.top;t.clearRect(0,0,e.width,e.height),t.drawImage(s,0,0),a(o,i,c,d)},d=()=>{n&&(n=!1,this.saveState(e))};e.addEventListener("mousedown",l),e.addEventListener("mousemove",c),e.addEventListener("mouseup",d),e.arrowToolListeners={mousedown:l,mousemove:c,mouseup:d}},initRectangleTool(e,t){let n=!1,o=0,i=0,s=document.createElement("canvas");s.width=e.width,s.height=e.height;let r=s.getContext("2d");const a=t=>{n=!0;const a=e.getBoundingClientRect();o=t.clientX-a.left,i=t.clientY-a.top,r.clearRect(0,0,s.width,s.height),r.drawImage(e,0,0)},l=r=>{if(!n)return;const a=e.getBoundingClientRect(),l=r.clientX-a.left,c=r.clientY-a.top;switch(t.clearRect(0,0,e.width,e.height),t.drawImage(s,0,0),t.beginPath(),t.strokeStyle=this.state.currentShapeColor,t.fillStyle=this.state.currentShapeFillColor,t.lineWidth=this.state.currentShapeWidth,this.state.currentShapeStyle){case"dashed":t.setLineDash([8,8]);break;case"dotted":t.setLineDash([2,2]);break;default:t.setLineDash([])}const d=l-o,h=c-i,u=d<0?l:o,p=h<0?c:i,g=Math.abs(d),m=Math.abs(h);if("round"===this.state.currentCornerStyle){const e=Math.min(10,g/4,m/4);t.beginPath(),t.moveTo(u+e,p),t.lineTo(u+g-e,p),t.quadraticCurveTo(u+g,p,u+g,p+e),t.lineTo(u+g,p+m-e),t.quadraticCurveTo(u+g,p+m,u+g-e,p+m),t.lineTo(u+e,p+m),t.quadraticCurveTo(u,p+m,u,p+m-e),t.lineTo(u,p+e),t.quadraticCurveTo(u,p,u+e,p),t.closePath()}else t.beginPath(),t.rect(u,p,g,m);"transparent"!==this.state.currentShapeFillColor&&t.fill(),t.stroke(),t.setLineDash([])},c=()=>{n&&(n=!1,this.saveState(e))};e.addEventListener("mousedown",a),e.addEventListener("mousemove",l),e.addEventListener("mouseup",c),e.rectToolListeners={mousedown:a,mousemove:l,mouseup:c}},initCircleTool(e,t){let n=!1,o=0,i=0,s=document.createElement("canvas");s.width=e.width,s.height=e.height;let r=s.getContext("2d");const a=t=>{n=!0;const a=e.getBoundingClientRect();o=t.clientX-a.left,i=t.clientY-a.top,r.clearRect(0,0,s.width,s.height),r.drawImage(e,0,0)},l=r=>{if(!n)return;const a=e.getBoundingClientRect(),l=r.clientX-a.left,c=r.clientY-a.top;t.clearRect(0,0,e.width,e.height),t.drawImage(s,0,0);const d=Math.abs(l-o)/2,h=Math.abs(c-i)/2,u=o+(l-o)/2,p=i+(c-i)/2;switch(t.beginPath(),t.ellipse(u,p,d,h,0,0,2*Math.PI),t.strokeStyle=this.state.currentShapeColor,t.fillStyle=this.state.currentShapeFillColor,t.lineWidth=this.state.currentShapeWidth,this.state.currentShapeStyle){case"dashed":t.setLineDash([8,8]);break;case"dotted":t.setLineDash([2,2]);break;default:t.setLineDash([])}"transparent"!==this.state.currentShapeFillColor&&t.fill(),t.stroke(),t.setLineDash([])},c=()=>{n&&(n=!1,this.saveState(e))};e.addEventListener("mousedown",a),e.addEventListener("mousemove",l),e.addEventListener("mouseup",c),e.circleToolListeners={mousedown:a,mousemove:l,mouseup:c}},initTextTool(e,t){const n=n=>{const o=e.getBoundingClientRect(),i=n.clientX-o.left,s=n.clientY-o.top,r=document.createElement("div");r.className="annotation-text-input",r.contentEditable=!0,Object.assign(r.style,{position:"absolute",left:`${i}px`,top:`${s}px`,minWidth:"1px",minHeight:"30px",padding:"0",border:"none",background:"transparent",color:this.state.currentTextColor,fontSize:`${this.state.currentFontSize}px`,fontFamily:this.state.currentFontFamily,outline:"none",caretColor:this.state.currentTextColor,whiteSpace:"pre",zIndex:"1000003"});const a=document.createElement("style");a.textContent=`\n        @keyframes blink {\n          0%, 100% { opacity: 1; }\n          25%, 75% { opacity: 0; }\n        }\n        .annotation-text-input:empty:focus::before {\n          content: '';\n          border-left: 1px solid ${this.state.currentTextColor};\n          position: absolute;\n          height: ${this.state.currentFontSize}px;\n          opacity: 1;\n          animation: blink 2s ease-in-out infinite;\n          animation-play-state: running;\n        }\n        .annotation-text-input:not(:empty):focus::before {\n          animation-play-state: paused;\n          opacity: 0;\n        }\n      `,document.head.appendChild(a),e.parentElement.appendChild(r),r.focus(),r.onblur=()=>{r.textContent.trim()&&(t.fillStyle=this.state.currentTextColor,t.font=`${this.state.currentFontSize}px ${this.state.currentFontFamily}`,t.fillText(r.textContent,i,s+this.state.currentFontSize),this.saveState(e)),r.remove(),a.remove()},r.onkeydown=e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),r.blur())}};e.addEventListener("click",n),e.textToolListeners={click:n}},toggleLineWidthPanel(e,t){const n=document.querySelector(`.${t}-width-panel`);n&&(n.style.display=e?"block":"none",this.state.isLineWidthPanelVisible=e)},createLineWidthPanel(e){const t=document.createElement("div");let n;if(t.className=`line-width-panel ${e}-width-panel`,Object.assign(t.style,{position:"absolute",left:"100%",top:"0",marginLeft:"10px",backgroundColor:"#2c2c2c",borderRadius:"6px",padding:"8px",display:"none",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.15)",zIndex:"1000003"}),"eraser"===e)n=[4,8,12,16,20];else n=[2,4,6,8,10];return n.forEach((n=>{const o=document.createElement("div");Object.assign(o.style,{width:"100px",height:"24px",display:"flex",alignItems:"center",justifyContent:"center",padding:"4px",cursor:"pointer",borderRadius:"4px",marginBottom:"4px"});const i=document.createElement("div");Object.assign(i.style,{width:"60px",height:`${n}px`,backgroundColor:"eraser"===e?"#666":"#fff",borderRadius:n/2+"px"}),o.appendChild(i),o.addEventListener("mouseover",(()=>{o.style.backgroundColor="#3c3c3c"})),o.addEventListener("mouseout",(()=>{o.style.backgroundColor="transparent"})),o.addEventListener("click",(()=>{switch(e){case"eraser":this.state.currentEraserWidth=n;break;case"arrow":this.state.currentArrowWidth=n;break;case"pen":this.state.currentPenWidth=n}this.toggleLineWidthPanel(!1,e),this.state.currentTool&&this.initDrawingCanvas(this.state.currentTool)})),t.appendChild(o)})),t},createArrowStylePanel(){const e=document.createElement("div");e.className="arrow-style-panel",Object.assign(e.style,{position:"absolute",left:"100%",top:"0",marginLeft:"10px",backgroundColor:"#2c2c2c",borderRadius:"6px",padding:"12px",display:"none",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.15)",zIndex:"1000003",width:"180px"});const t=document.createElement("div");t.className="arrow-color-section";const n=document.createElement("div");n.textContent="描边颜色",n.style.color="#fff",n.style.fontSize="14px",n.style.marginBottom="8px",t.appendChild(n);const o=document.createElement("div");Object.assign(o.style,{display:"flex",gap:"8px",alignItems:"flex-start"});const i=document.createElement("div");Object.assign(i.style,{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:"4px",flex:"1"});["#ff0000","#ff9800","#ffeb3b","#4caf50","#2196f3","#9c27b0","#000000","#ffffff"].forEach((e=>{const t=document.createElement("div");Object.assign(t.style,{width:"20px",height:"20px",backgroundColor:e,borderRadius:"4px",cursor:"pointer",border:"1px solid rgba(255, 255, 255, 0.1)",boxSizing:"border-box"}),t.className="color-box",t.addEventListener("click",(()=>{this.state.currentArrowColor=e,o.querySelectorAll(".color-box").forEach((e=>{e.style.outline="none"})),t.style.outline="2px solid #fff",t.style.outlineOffset="1px",a.style.backgroundColor=e,l.value=e,"arrow"===this.state.currentTool&&this.initDrawingCanvas("arrow")})),e===this.state.currentArrowColor&&(t.style.outline="2px solid #fff",t.style.outlineOffset="1px"),i.appendChild(t)}));const s=document.createElement("div");Object.assign(s.style,{display:"flex",alignItems:"center",gap:"8px"});const r=document.createElement("div");Object.assign(r.style,{width:"1px",height:"44px",backgroundColor:"#444"});const a=document.createElement("div");Object.assign(a.style,{width:"20px",height:"20px",backgroundColor:this.state.currentArrowColor,borderRadius:"4px",cursor:"pointer",position:"relative",border:"1px solid rgba(255, 255, 255, 0.1)",boxSizing:"border-box"});const l=document.createElement("input");l.type="color",l.value=this.state.currentArrowColor,Object.assign(l.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%",opacity:0,cursor:"pointer"}),l.addEventListener("change",(e=>{const t=e.target.value;this.state.currentArrowColor=t,a.style.backgroundColor=t,o.querySelectorAll(".color-box").forEach((e=>{e.style.outline="none",e.style.backgroundColor===t&&(e.style.outline="2px solid #fff",e.style.outlineOffset="1px")})),"arrow"===this.state.currentTool&&this.initDrawingCanvas("arrow")})),a.appendChild(l),s.appendChild(r),s.appendChild(a),o.appendChild(i),o.appendChild(s),t.appendChild(o),e.appendChild(t);const c=document.createElement("div");c.className="arrow-width-section";const d=document.createElement("div");d.textContent="描边宽度",d.style.color="#fff",d.style.fontSize="14px",d.style.margin="12px 0 8px",c.appendChild(d);const h=document.createElement("div");Object.assign(h.style,{display:"flex",marginBottom:"12px",gap:"8px"}),[2,4,6].forEach((e=>{const t=document.createElement("div");Object.assign(t.style,{width:"32px",height:"32px",backgroundColor:"#3c3c3c",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"});const n=document.createElement("div");Object.assign(n.style,{width:"16px",height:`${e}px`,backgroundColor:"#fff",borderRadius:e/2+"px"}),t.appendChild(n),t.addEventListener("click",(()=>{this.state.currentArrowWidth=e,h.querySelectorAll(".width-option").forEach((e=>{e.style.backgroundColor="#3c3c3c"})),t.style.backgroundColor="#666","arrow"===this.state.currentTool&&this.initDrawingCanvas("arrow")})),t.className="width-option",e===this.state.currentArrowWidth&&(t.style.backgroundColor="#666"),h.appendChild(t)})),c.appendChild(h),e.appendChild(c);const u=document.createElement("div");u.className="arrow-style-section";const p=document.createElement("div");p.textContent="边框样式",p.style.color="#fff",p.style.fontSize="14px",p.style.marginBottom="8px",u.appendChild(p);const g=document.createElement("div");Object.assign(g.style,{display:"flex",gap:"8px"});return[{id:"solid",preview:'<svg width="20" height="20" viewBox="0 0 20 20" fill="none">\n          <line x1="2" y1="10" x2="18" y2="10" stroke="currentColor" stroke-width="2"/>\n        </svg>'},{id:"dashed",preview:'<svg aria-hidden="true" focusable="false" role="img" viewBox="0 0 24 24" class="" fill="none" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><g stroke-width="2"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M5 12h2"></path><path d="M17 12h2"></path><path d="M11 12h2"></path></g></svg>'},{id:"dotted",preview:'<svg aria-hidden="true" focusable="false" role="img" viewBox="0 0 24 24" class="" fill="none" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><g stroke-width="2"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 12v.01"></path><path d="M8 12v.01"></path><path d="M12 12v.01"></path><path d="M16 12v.01"></path><path d="M20 12v.01"></path></g></svg>'}].forEach((e=>{const t=document.createElement("div");Object.assign(t.style,{width:"32px",height:"32px",backgroundColor:e.id===this.state.currentArrowStyle?"#666":"#3c3c3c",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff"}),t.innerHTML=e.preview;const n=t.querySelector("svg");n&&Object.assign(n.style,{color:"inherit",width:"20px",height:"20px"}),t.addEventListener("mouseover",(()=>{e.id!==this.state.currentArrowStyle&&(t.style.backgroundColor="#4c4c4c")})),t.addEventListener("mouseout",(()=>{e.id!==this.state.currentArrowStyle&&(t.style.backgroundColor="#3c3c3c")})),t.addEventListener("click",(()=>{this.state.currentArrowStyle=e.id,g.querySelectorAll("div").forEach((e=>{e.style.backgroundColor="#3c3c3c"})),t.style.backgroundColor="#666","arrow"===this.state.currentTool&&this.initDrawingCanvas("arrow")})),g.appendChild(t)})),u.appendChild(g),e.appendChild(u),e},toggleArrowStylePanel(e){const t=document.querySelector(".arrow-style-panel");t&&(t.style.display=e?"block":"none")},createShapeStylePanel(){const e=document.createElement("div");e.className="shape-style-panel",Object.assign(e.style,{position:"absolute",left:"100%",top:"0",marginLeft:"10px",backgroundColor:"#2c2c2c",borderRadius:"6px",padding:"12px",display:"none",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.15)",zIndex:"1000003",width:"180px"});const t=document.createElement("div");t.className="shape-stroke-section";const n=document.createElement("div");n.textContent="描边颜色",n.style.color="#fff",n.style.fontSize="14px",n.style.marginBottom="8px",t.appendChild(n);const o=this.createColorPicker(["#ff0000","#ff9800","#ffeb3b","#4caf50","#2196f3"],"currentShapeColor");t.appendChild(o),e.appendChild(t);const i=document.createElement("div");i.className="shape-fill-section",i.style.marginTop="12px";const s=document.createElement("div");s.textContent="背景颜色",s.style.color="#fff",s.style.fontSize="14px",s.style.marginBottom="8px",i.appendChild(s);const r=this.createColorPicker(["transparent","#ff0000","#ff9800","#ffeb3b","#4caf50"],"currentShapeFillColor");i.appendChild(r),e.appendChild(i);const a=document.createElement("div");a.className="shape-width-section",a.style.marginTop="12px";const l=document.createElement("div");l.textContent="描边宽度",l.style.color="#fff",l.style.fontSize="14px",l.style.marginBottom="8px",a.appendChild(l);const c=document.createElement("div");Object.assign(c.style,{display:"flex",gap:"8px"}),[2,4,6].forEach((e=>{const t=document.createElement("div");Object.assign(t.style,{width:"32px",height:"32px",backgroundColor:e===this.state.currentShapeWidth?"#666":"#3c3c3c",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"});const n=document.createElement("div");Object.assign(n.style,{width:"16px",height:`${e}px`,backgroundColor:"#fff",borderRadius:e/2+"px"}),t.appendChild(n),t.addEventListener("click",(()=>{this.state.currentShapeWidth=e,c.querySelectorAll(":scope > div").forEach((e=>{e.style.backgroundColor="#3c3c3c"})),t.style.backgroundColor="#666",["rectangle","circle"].includes(this.state.currentTool)&&this.initDrawingCanvas(this.state.currentTool)})),c.appendChild(t)})),a.appendChild(c),e.appendChild(a);const d=document.createElement("div");d.className="shape-style-section",d.style.marginTop="12px";const h=document.createElement("div");h.textContent="边框样式",h.style.color="#fff",h.style.marginBottom="8px",h.style.fontSize="14px",d.appendChild(h);const u=document.createElement("div");Object.assign(u.style,{display:"flex",gap:"8px"});if([{id:"solid",preview:'<svg width="20" height="20" viewBox="0 0 20 20" fill="none">\n          <line x1="2" y1="10" x2="18" y2="10" stroke="currentColor" stroke-width="2"/>\n        </svg>'},{id:"dashed",preview:'<svg aria-hidden="true" focusable="false" role="img" viewBox="0 0 24 24" class="" fill="none" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><g stroke-width="2"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M5 12h2"></path><path d="M17 12h2"></path><path d="M11 12h2"></path></g></svg>'},{id:"dotted",preview:'<svg aria-hidden="true" focusable="false" role="img" viewBox="0 0 24 24" class="" fill="none" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><g stroke-width="2"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 12v.01"></path><path d="M8 12v.01"></path><path d="M12 12v.01"></path><path d="M16 12v.01"></path><path d="M20 12v.01"></path></g></svg>'}].forEach((e=>{const t=document.createElement("div");Object.assign(t.style,{width:"32px",height:"32px",backgroundColor:e.id===this.state.currentShapeStyle?"#666":"#3c3c3c",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff"}),t.innerHTML=e.preview;const n=t.querySelector("svg");n&&Object.assign(n.style,{color:"inherit",width:"20px",height:"20px"}),t.addEventListener("mouseover",(()=>{e.id!==this.state.currentShapeStyle&&(t.style.backgroundColor="#4c4c4c")})),t.addEventListener("mouseout",(()=>{e.id!==this.state.currentShapeStyle&&(t.style.backgroundColor="#3c3c3c")})),t.addEventListener("click",(()=>{this.state.currentShapeStyle=e.id,u.querySelectorAll("div").forEach((e=>{e.style.backgroundColor="#3c3c3c"})),t.style.backgroundColor="#666",["rectangle","circle"].includes(this.state.currentTool)&&this.initDrawingCanvas(this.state.currentTool)})),u.appendChild(t)})),d.appendChild(u),e.appendChild(d),"rectangle"===this.state.currentTool){const t=document.createElement("div");t.className="shape-corner-section",t.style.marginTop="12px";const n=document.createElement("div");n.textContent="边角样式",n.style.color="#fff",n.style.fontSize="14px",n.style.marginBottom="8px",t.appendChild(n);const o=document.createElement("div");Object.assign(o.style,{display:"flex",gap:"8px"});[{id:"sharp",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">\n            <line x1="2" y1="10" x2="18" y2="10" stroke="currentColor" stroke-width="2"/>\n          </svg>',tooltip:"直角"},{id:"round",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16"><path fill="currentColor" d="M4 3.75C4 2.784 4.784 2 5.75 2h.75a.5.5 0 0 1 0 1h-.75a.75.75 0 0 0-.75.75v.75a.5.5 0 0 1-1 0zM8 2.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m5.25-.5c.966 0 1.75.784 1.75 1.75v.75a.5.5 0 0 1-1 0v-.75a.75.75 0 0 0-.75-.75h-.75a.5.5 0 0 1 0-1zM8 11.5a.5.5 0 0 0 .5.5h2a.5.5 0 0 0 0-1h-2a.5.5 0 0 0-.5.5m-2.25.5A1.75 1.75 0 0 1 4 10.25V9.5a.5.5 0 0 1 1 0v.75c0 .414.336.75.75.75h.75a.5.5 0 0 1 0 1zM15 10.25A1.75 1.75 0 0 1 13.25 12h-.75a.5.5 0 0 1 0-1h.75a.75.75 0 0 0 .75-.75V9.5a.5.5 0 0 1 1 0zM4.5 6a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 1 0v-1a.5.5 0 0 0-.5-.5m9.5.5a.5.5 0 0 1 1 0v1a.5.5 0 0 1-1 0zM1 7.411a3.4 3.4 0 0 1 1-2.408v5.249c0 .908.323 1.74.86 2.388a3.74 3.74 0 0 0 2.89 1.361h3.84q.048 0 .094-.002H12a3.4 3.4 0 0 1-2.41 1.002H5.75A4.75 4.75 0 0 1 1 10.251z"/></svg>',tooltip:"圆角"}].forEach((e=>{const t=document.createElement("div");Object.assign(t.style,{width:"32px",height:"32px",backgroundColor:e.id===this.state.currentCornerStyle?"#666":"#3c3c3c",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff"}),t.innerHTML=e.icon,t.title=e.tooltip,t.addEventListener("mouseover",(()=>{e.id!==this.state.currentCornerStyle&&(t.style.backgroundColor="#4c4c4c")})),t.addEventListener("mouseout",(()=>{e.id!==this.state.currentCornerStyle&&(t.style.backgroundColor="#3c3c3c")})),t.addEventListener("click",(()=>{this.state.currentCornerStyle=e.id,o.querySelectorAll("div").forEach((e=>{e.style.backgroundColor="#3c3c3c"})),t.style.backgroundColor="#666","rectangle"===this.state.currentTool&&this.initDrawingCanvas(this.state.currentTool)})),o.appendChild(t)})),t.appendChild(o),e.appendChild(t)}return e},toggleShapeStylePanel(e){const t=document.querySelector(".shape-style-panel");t&&(t.style.display=e?"block":"none")},createColorPicker(e,t){const n=document.createElement("div");Object.assign(n.style,{display:"flex",gap:"8px",alignItems:"center"});const o=document.createElement("div");Object.assign(o.style,{display:"flex",gap:"4px",flex:1}),e.forEach((e=>{const i=document.createElement("div");Object.assign(i.style,{width:"24px",height:"24px",borderRadius:"4px",cursor:"pointer",border:"1px solid rgba(255, 255, 255, 0.1)",boxSizing:"border-box"}),"transparent"===e?(i.style.background="linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%)",i.style.backgroundSize="8px 8px",i.style.backgroundPosition="0 0, 0 4px, 4px -4px, -4px 0px",i.style.backgroundColor="white"):i.style.backgroundColor=e,i.addEventListener("click",(()=>{this.state[t]=e,n.querySelectorAll(".color-box").forEach((e=>{e.style.outline="none"})),i.style.outline="2px solid #fff",i.style.outlineOffset="1px",["rectangle","circle"].includes(this.state.currentTool)&&this.initDrawingCanvas(this.state.currentTool)})),e===this.state[t]&&(i.style.outline="2px solid #fff",i.style.outlineOffset="1px"),i.className="color-box",o.appendChild(i)}));const i=document.createElement("input");return i.type="color",i.value="transparent"===this.state[t]?"#ffffff":this.state[t],Object.assign(i.style,{width:"24px",height:"24px",padding:"0",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:"4px",cursor:"pointer",backgroundColor:"transparent"}),i.addEventListener("change",(e=>{this.state[t]=e.target.value,n.querySelectorAll(".color-box").forEach((e=>{e.style.outline="none"})),["rectangle","circle"].includes(this.state.currentTool)&&this.initDrawingCanvas(this.state.currentTool)})),n.appendChild(o),n.appendChild(i),n},updateToolState(e,t){switch(e){case"pen":this.state.currentPenColor=t.color||this.state.currentPenColor,this.state.currentPenWidth=t.width||this.state.currentPenWidth;break;case"eraser":this.state.currentEraserWidth=t.width||this.state.currentEraserWidth;break;case"arrow":this.state.currentArrowColor=t.color||this.state.currentArrowColor,this.state.currentArrowWidth=t.width||this.state.currentArrowWidth,this.state.currentArrowStyle=t.style||this.state.currentArrowStyle;break;case"rectangle":case"circle":this.state.currentShapeColor=t.color||this.state.currentShapeColor,this.state.currentShapeWidth=t.width||this.state.currentShapeWidth,this.state.currentShapeFillColor=t.fillColor||this.state.currentShapeFillColor,this.state.currentShapeStyle=t.style||this.state.currentShapeStyle,"rectangle"===e&&(this.state.currentCornerStyle=t.cornerStyle||this.state.currentCornerStyle);break;case"text":this.state.currentTextColor=t.color||this.state.currentTextColor,this.state.currentFontSize=t.fontSize||this.state.currentFontSize,this.state.currentFontFamily=t.fontFamily||this.state.currentFontFamily}this.state.currentTool===e&&this.initDrawingCanvas(e)},createTextStylePanel(){const e=document.createElement("div");e.className="text-style-panel",Object.assign(e.style,{position:"absolute",left:"100%",top:"0",marginLeft:"10px",backgroundColor:"#2c2c2c",borderRadius:"6px",padding:"12px",display:"none",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.15)",zIndex:"1000003",width:"180px"});const t=document.createElement("div");t.className="text-color-section";const n=document.createElement("div");n.textContent="文字颜色",n.style.color="#fff",n.style.fontSize="14px",n.style.marginBottom="8px",t.appendChild(n);const o=this.createColorPicker(["#ff0000","#ff9800","#ffeb3b","#4caf50","#2196f3"],"currentTextColor");t.appendChild(o),e.appendChild(t);const i=document.createElement("div");i.className="text-font-section",i.style.marginTop="12px";const s=document.createElement("div");s.textContent="字体",s.style.color="#fff",s.style.fontSize="14px",s.style.marginBottom="8px",i.appendChild(s);const r=document.createElement("div");Object.assign(r.style,{display:"flex",gap:"4px"}),this.loadCustomFonts(),this.state.availableFonts.forEach((e=>{const t=document.createElement("div");Object.assign(t.style,{width:"32px",height:"32px",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:e.name===this.state.currentFontFamily?"#666":"#3c3c3c"}),t.innerHTML=`\n        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" \n            font-family="${e.name}" fill="white" font-size="16">A</text>\n          </svg>\n      `,t.title=e.label,t.addEventListener("mouseover",(()=>{e.name!==this.state.currentFontFamily&&(t.style.backgroundColor="#4c4c4c")})),t.addEventListener("mouseout",(()=>{e.name!==this.state.currentFontFamily&&(t.style.backgroundColor="#3c3c3c")})),t.addEventListener("click",(()=>{this.state.currentFontFamily=e.name,r.querySelectorAll("div").forEach((e=>{e.style.backgroundColor="#3c3c3c"})),t.style.backgroundColor="#666","text"===this.state.currentTool&&this.initDrawingCanvas("text")})),r.appendChild(t)})),i.appendChild(r),e.appendChild(i);const a=document.createElement("div");a.className="text-size-section",a.style.marginTop="12px";const l=document.createElement("div");l.textContent="字体大小",l.style.color="#fff",l.style.fontSize="14px",l.style.marginBottom="8px",a.appendChild(l);const c=document.createElement("div");return Object.assign(c.style,{display:"flex",gap:"8px"}),this.state.availableSizes.forEach((e=>{const t=document.createElement("div");Object.assign(t.style,{width:"32px",height:"32px",backgroundColor:e.value===this.state.currentFontSize?"#666":"#3c3c3c",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:"14px"}),t.textContent=e.label,t.addEventListener("mouseover",(()=>{e.value!==this.state.currentFontSize&&(t.style.backgroundColor="#4c4c4c")})),t.addEventListener("mouseout",(()=>{e.value!==this.state.currentFontSize&&(t.style.backgroundColor="#3c3c3c")})),t.addEventListener("click",(()=>{this.state.currentFontSize=e.value,c.querySelectorAll("div").forEach((e=>{e.style.backgroundColor="#3c3c3c"})),t.style.backgroundColor="#666","text"===this.state.currentTool&&this.initDrawingCanvas("text")})),c.appendChild(t)})),a.appendChild(c),e.appendChild(a),e},toggleTextStylePanel(e){const t=document.querySelector(".text-style-panel");t&&(t.style.display=e?"block":"none")},createBlurSettingsPanel(){const e=document.createElement("div");e.className="blur-settings-panel",Object.assign(e.style,{position:"absolute",left:"100%",top:"0",marginLeft:"10px",backgroundColor:"#2c2c2c",borderRadius:"6px",padding:"12px",display:"none",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.15)",zIndex:"1000003",width:"180px"});const t=document.createElement("div"),n=document.createElement("div");n.textContent="模糊强度",n.style.color="#fff",n.style.marginBottom="8px",t.appendChild(n);const o=document.createElement("div");Object.assign(o.style,{display:"flex",gap:"8px"}),[5,10,15,20].forEach((e=>{const t=document.createElement("div");Object.assign(t.style,{width:"32px",height:"32px",backgroundColor:e===this.state.currentBlurRadius?"#666":"#3c3c3c",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff"}),t.textContent=e,t.addEventListener("click",(()=>{this.state.currentBlurRadius=e,o.querySelectorAll("div").forEach((e=>{e.style.backgroundColor="#3c3c3c"})),t.style.backgroundColor="#666"})),o.appendChild(t)})),t.appendChild(o),e.appendChild(t);const i=document.createElement("div");i.style.marginTop="12px";const s=document.createElement("div");s.textContent="笔刷宽度",s.style.color="#fff",s.style.marginBottom="8px",i.appendChild(s);const r=document.createElement("div");return Object.assign(r.style,{display:"flex",gap:"8px"}),[20,30,40,50].forEach((e=>{const t=document.createElement("div");Object.assign(t.style,{width:"32px",height:"32px",backgroundColor:e===this.state.currentBlurWidth?"#666":"#3c3c3c",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff"}),t.textContent=e,t.addEventListener("click",(()=>{this.state.currentBlurWidth=e,r.querySelectorAll("div").forEach((e=>{e.style.backgroundColor="#3c3c3c"})),t.style.backgroundColor="#666"})),r.appendChild(t)})),i.appendChild(r),e.appendChild(i),e},toggleBlurSettingsPanel(e){const t=document.querySelector(".blur-settings-panel");t&&(t.style.display=e?"block":"none")},initBlurTool(e,t){let n=!1,o=0,i=0;const s=document.createElement("canvas");s.width=e.width,s.height=e.height;const r=s.getContext("2d"),a=document.createElement("canvas");a.width=e.width,a.height=e.height;const l=a.getContext("2d"),c=t=>{n=!0;const a=e.getBoundingClientRect();o=t.clientX-a.left,i=t.clientY-a.top,r.clearRect(0,0,s.width,s.height),r.drawImage(e,0,0)},d=r=>{if(!n)return;const c=e.getBoundingClientRect(),d=r.clientX-c.left,h=r.clientY-c.top;l.clearRect(0,0,a.width,a.height),l.beginPath(),l.moveTo(o,i),l.lineTo(d,h),l.lineWidth=this.state.currentBlurWidth,l.lineCap="round",l.strokeStyle="#fff",l.stroke(),t.clearRect(0,0,e.width,e.height),t.drawImage(s,0,0),t.save(),t.globalCompositeOperation="destination-out",t.drawImage(a,0,0),t.restore(),t.save(),t.filter=`blur(${this.state.currentBlurRadius}px)`,t.globalCompositeOperation="destination-over",t.drawImage(s,0,0),t.restore(),t.save(),t.globalCompositeOperation="destination-over",t.drawImage(s,0,0),t.restore(),o=d,i=h},h=()=>{n&&(n=!1,this.saveState(e))};e.addEventListener("mousedown",c),e.addEventListener("mousemove",d),e.addEventListener("mouseup",h),e.addEventListener("mouseleave",h),e.blurToolListeners={mousedown:c,mousemove:d,mouseup:h,mouseleave:h}}};function n(e){const t=document.createElement("div");Object.assign(t.style,{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"rgba(0, 0, 0, 0.8)",color:"#fff",padding:"8px 16px",borderRadius:"4px",fontSize:"14px",zIndex:"1000004",pointerEvents:"none"}),t.textContent=e,document.body.appendChild(t),setTimeout((()=>{t.remove()}),1e3)}
