chrome.runtime.onMessage.addListener(((e,t,n)=>{"initScreenshot"===e.action&&function(){if(document.querySelector(".screenshot-overlay"))return;const e={isDrawing:!1,isSelected:!1,isDragSelecting:!1,selection:null,selectedElement:null,highlightElement:null,highlightTimeout:null},t={overlay:function(){const e=document.createElement("div");return e.className="screenshot-overlay",e}(),hint:function(){const e=document.createElement("div");e.className="screenshot-hint",e.innerHTML='\n      <div class="screenshot-hint-text">\n        在此页面上拖拽或单击选择截图区域<br>\n        按 ESC 键取消截图\n      </div>\n    ';const t=document.createElement("button");return t.className="screenshot-hint-button",t.textContent="取消",t.onclick=e=>{e.preventDefault(),e.stopPropagation(),u()},e.appendChild(t),e}()},n={create(t){e.highlightTimeout&&clearTimeout(e.highlightTimeout),e.highlightTimeout=setTimeout((()=>{this.remove();const n=t.getBoundingClientRect();e.highlightElement=document.createElement("div"),e.highlightElement.className="element-highlight",this.updatePosition(e.highlightElement,n),document.body.appendChild(e.highlightElement)}),5)},remove(){e.highlightElement&&(e.highlightElement.remove(),e.highlightElement=null)},updatePosition(e,t){e.style.position="fixed",e.style.left=`${t.left}px`,e.style.top=`${t.top}px`,e.style.width=`${t.width}px`,e.style.height=`${t.height}px`}},i={create:()=>(e.selection=document.createElement("div"),e.selection.className="selected-element",document.body.appendChild(e.selection),e.selection),updatePosition(t){if(!e.selection)return;let{left:n,top:i,width:o,height:s}=this.checkBoundary(t);e.selection.style.position="fixed",e.selection.style.left=`${n}px`,e.selection.style.top=`${i}px`,e.selection.style.width=`${o}px`,e.selection.style.height=`${s}px`,this.updateClipPath(n,i,o,s)},checkBoundary(e){let{left:t,top:n,width:i,height:o}=e;const s=document.documentElement.clientWidth,l=document.documentElement.clientHeight;return t<0&&(t=3),t+i>s&&(i=s-t-3),n<0&&(n=3),n+o>l&&(o=l-n-60),{left:t,top:n,width:i,height:o}},updateClipPath(e,n,i,o){const s=document.documentElement.clientWidth,l=document.documentElement.clientHeight,c=e/s*100,h=n/l*100,r=i/s*100,a=o/l*100;t.overlay.style.clipPath=`\n        polygon(\n          0 0, 100% 0, 100% 100%, 0 100%, 0 0,\n          ${c}% ${h}%,\n          ${c}% ${h+a}%,\n          ${c+r}% ${h+a}%,\n          ${c+r}% ${h}%,\n          ${c}% ${h}%\n        )\n      `}},o={create(e){const t=document.createElement("div");t.className="toolbar",this.setStyle(t),[this.createCloseButton(),this.createFullscreenButton(),this.createDownloadButton()].forEach((e=>t.appendChild(e))),e.appendChild(t)},setStyle(e){Object.assign(e.style,{width:"180px",height:"46px",position:"absolute",right:"-1px",bottom:"-60px",whiteSpace:"nowrap",display:"flex",justifyContent:"space-around",alignItems:"center"})},createCloseButton(){return this.createButton("toolbar-button-cancel","X",u)},createFullscreenButton(){return this.createButton("toolbar-button-visible","全屏",(()=>{this.capture("captureVisible")}))},createDownloadButton(){return this.createButton("toolbar-button","下载",(()=>{const t=e.selection.getBoundingClientRect();this.capture("captureArea",{x:t.left,y:t.top,width:t.width,height:t.height})}))},createButton(e,t,n){const i=document.createElement("button");return i.className=e,i.innerHTML=this.getButtonHTML(t),i.onclick=e=>{e.preventDefault(),e.stopPropagation(),n()},i},getButtonHTML(e){switch(e){case"X":return'\n            <svg width="16" height="16" viewBox="0 0 16 16">\n              <path d="M8 6.586L3.707 2.293 2.293 3.707 6.586 8l-4.293 4.293 1.414 1.414L8 9.414l4.293 4.293 1.414-1.414L9.414 8l4.293-4.293-1.414-1.414L8 6.586z"/>\n            </svg>\n          ';case"全屏":return'\n            <div style="display: flex; align-items: center; justify-content: center;">\n              <svg width="16" height="16" viewBox="0 0 16 16" style="margin-right: 4px;">\n                <path d="M1.5 1h4v1.5h-2.5v2.5h-1.5v-4zm13 0v4h-1.5v-2.5h-2.5v-1.5h4zm-13 13v-4h1.5v2.5h2.5v1.5h-4zm13 0h-4v-1.5h2.5v-2.5h1.5v4z"/>\n              </svg>\n              <span>全屏</span>\n            </div>\n          ';case"下载":return'\n            <div style="display: flex; align-items: center; justify-content: center; fill: white;">\n              <svg width="16" height="16" viewBox="0 0 16 16" style="margin-right: 4px;">\n                <path d="M8 12l-4.5-4.5 1.5-1.5 2 2v-6h2v6l2-2 1.5 1.5-4.5 4.5zm-6 2h12v-2h-12v2z"/>\n              </svg>\n              <span>下载</span>\n            </div>\n          ';default:return e}},capture(n,i=null){t.overlay.style.display="none",e.selection.style.display="none",chrome.runtime.sendMessage({action:n,...i&&{area:i}},(e=>{e?.success?console.log(`${n} 成功`):console.error(`${n} 失败:`,e?.error),u()}))}};function s(i){if(t.overlay.parentElement&&!e.isSelected){t.overlay.style.pointerEvents="none";const o=document.elementFromPoint(i.clientX,i.clientY);t.overlay.style.pointerEvents="auto",!o||o.classList.contains("screenshot-overlay")||o.classList.contains("element-highlight")||o===e.selectedElement||(n.create(o),e.selectedElement=o)}}function l(s){if(!t.overlay.parentElement||e.isSelected)return;const l=s.clientX,c=s.clientY;let h=!1;function r(o){const s=Math.abs(o.clientX-l),r=Math.abs(o.clientY-c);if(s>5||r>5){h=!0,t.hint.classList.add("hidden"),n.remove(),e.selectedElement=null,e.selection||(e.selection=i.create(),a(e.selection),d(e.selection));const s={left:Math.min(l,o.clientX),top:Math.min(c,o.clientY),width:Math.abs(o.clientX-l),height:Math.abs(o.clientY-c)};i.updatePosition(s)}}return document.addEventListener("mousemove",r),document.addEventListener("mouseup",(function t(s){if(document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",t),h&&e.selection)e.isSelected=!0,o.create(e.selection);else if(e.selectedElement){e.isSelected=!0;const t=e.selectedElement.getBoundingClientRect();e.selection=i.create(),i.updatePosition(t),n.remove(),a(e.selection),d(e.selection),o.create(e.selection)}})),e.selectedElement?(e.isSelected=!0,s.preventDefault(),void s.stopPropagation()):void 0}function c(){t.overlay.parentElement||u()}function h(e){"Escape"===e.key&&u()}function r(){if(e.selection&&e.isSelected){const t=e.selection.getBoundingClientRect();i.updatePosition(t)}}function a(e){e.addEventListener("mousedown",(t=>{if(t.target!==e)return;t.preventDefault(),t.stopPropagation();const n=t.clientX,o=t.clientY,s=e.getBoundingClientRect();function l(e){e.preventDefault(),e.stopPropagation();const t=e.clientX-n,l=e.clientY-o,c={left:s.left+t,top:s.top+l,width:s.width,height:s.height};i.updatePosition(c)}document.addEventListener("mousemove",l),document.addEventListener("mouseup",(function e(){document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",e)}))}))}function d(e){["nw","n","ne","w","e","sw","s","se"].forEach((t=>{const n=document.createElement("div");n.className=`resize-handle ${t}`,n.style.pointerEvents="auto",n.style.zIndex="1000002",e.appendChild(n),n.onpointerdown=function(n){n.preventDefault(),n.stopPropagation();const o=n.clientX,s=n.clientY,l={left:e.offsetLeft,top:e.offsetTop,width:e.offsetWidth,height:e.offsetHeight,right:e.offsetLeft+e.offsetWidth,bottom:e.offsetTop+e.offsetHeight};function c(e){e.preventDefault(),e.stopPropagation();const n=e.clientX-o,c=e.clientY-s;let h={left:l.left,top:l.top,width:l.width,height:l.height};switch(t){case"nw":h.left=l.left+n,h.top=l.top+c,h.width=l.width-n,h.height=l.height-c;break;case"n":h.top=l.top+c,h.height=l.height-c;break;case"ne":h.top=l.top+c,h.width=l.width+n,h.height=l.height-c;break;case"w":h.left=l.left+n,h.width=l.width-n;break;case"e":h.width=l.width+n;break;case"sw":h.left=l.left+n,h.width=l.width-n,h.height=l.height+c;break;case"s":h.height=l.height+c;break;case"se":h.width=l.width+n,h.height=l.height+c}const r=20;h.width<r&&(t.includes("w")&&(h.left=l.right-r),h.width=r),h.height<r&&(t.includes("n")&&(h.top=l.bottom-r),h.height=r),i.updatePosition(h)}function h(){document.removeEventListener("pointermove",c),document.removeEventListener("pointerup",h),document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",h)}document.addEventListener("pointermove",c),document.addEventListener("pointerup",h),document.addEventListener("mousemove",c),document.addEventListener("mouseup",h)}}))}function u(){n.remove(),[t.overlay,e.selection,t.hint].forEach((e=>{e?.parentElement&&e.remove()})),document.removeEventListener("mousemove",s),document.removeEventListener("mousedown",l),document.removeEventListener("mouseup",c),document.removeEventListener("keydown",h),window.removeEventListener("resize",r)}t.overlay.appendChild(t.hint),document.body.appendChild(t.overlay),document.addEventListener("mousemove",s),document.addEventListener("mousedown",l),document.addEventListener("mouseup",c),document.addEventListener("keydown",h),window.addEventListener("resize",r)}()}));
